<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Transfer - Smart Banking</title>
    <link rel="stylesheet" href="css/hdfc_style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Specific Styles for Transfer Page */
        .transfer-container {
            display: flex;
            gap: 20px;
        }

        .transfer-content {
            flex: 2;
            background: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .transfer-history {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .history-card {
            background: #fff;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .history-card h4 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .icon-box {
            width: 30px;
            height: 30px;
            background: #f0f4f8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--hdfc-blue);
            margin-right: 10px;
        }

        /* Tabs */
        .transfer-tabs {
            display: flex;
            border-bottom: 2px solid #ccc;
            margin-bottom: 20px;
        }

        .transfer-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .transfer-tab.active {
            color: var(--hdfc-blue);
            border-bottom: 2px solid var(--hdfc-blue);
        }

        /* Form */
        .form-row {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .beneficiary-popup {
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            position: absolute;
            background: white;
            width: 100%;
            z-index: 10;
        }

        .beneficiary-item {
            padding: 8px;
            cursor: pointer;
        }

        .beneficiary-item:hover {
            background: #f0f4f8;
        }

        .payout-options {
            display: flex;
            gap: 20px;
        }

        .payout-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .alert-box {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }

        .alert-info {
            background: #e8f3fc;
            color: #004c8f;
            border: 1px solid #b8daff;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .verified-badge {
            display: inline-block;
            margin-top: 5px;
            font-size: 12px;
            color: #28a745;
            font-weight: bold;
            display: none;
        }
    </style>
</head>

<body>

    <!-- Top Header -->
    <div class="top-header">
        <div class="brand-logo">
            <i class="fa-solid fa-building-columns" style="font-size: 28px; color: #004c8f;"></i>
            <div style="margin-left:10px;">
                <span style="color:red; font-weight:bold; font-size:1.2em;">NetBanking</span><br>
                <span style="color:#004c8f; font-weight:bold; font-size:1.5em;">SMART BANK</span>
            </div>
        </div>
        <div class="user-info">
            <div>WELCOME <span id="user-name" style="font-weight:bold;">User</span></div>
            <div class="top-links">
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Navigation Tabs -->
    <nav class="main-nav">
        <a href="dashboard.html" class="nav-tab">Accounts</a>
        <a href="transfer.html" class="nav-tab active">Funds Transfer</a>
        <a href="bills.html" class="nav-tab">BillPay & Recharge</a>
        <a href="cards.html" class="nav-tab">Cards</a>
        <a href="profile.html" class="nav-tab"
            style="margin-left:auto; border-left:1px solid #ccc; border-right:none;">Profile Management</a>
        <a href="support.html" class="nav-tab" style="border-right:1px solid #ccc;">Support</a>
    </nav>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">Transfers</div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active">Fund Transfer <span class="blue-arrow">▶</span></a></li>
                <li><a href="beneficiaries.html">Manage Beneficiaries</a></li>
                <li><a href="#">Scheduled Transfers</a></li>
                <li><a href="#">Transaction Status</a></li>
            </ul>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <div class="page-title">Fund Transfer</div>

            <div class="transfer-container">
                <!-- Left: Transfer Form -->
                <div class="transfer-content">

                    <div class="transfer-tabs">
                        <div class="transfer-tab" onclick="switchTab('internal')">Between My Accounts</div>
                        <div class="transfer-tab active" onclick="switchTab('smart')">To Another SMART BANK User</div>
                        <div class="transfer-tab" onclick="switchTab('external')">To Other Bank Account</div>
                    </div>

                    <!-- Alerts -->
                    <div id="transfer-alert" class="alert-box"></div>

                    <form id="transfer-form" onsubmit="event.preventDefault(); submitTransfer();">
                        <input type="hidden" id="transfer-type" value="TRANSFER">

                        <div class="form-row">
                            <label class="form-label">From Account</label>
                            <select id="from-account" class="form-control" onchange="loadHistory(this.value)">
                                <option>Loading...</option>
                            </select>
                            <div style="font-size:12px; color:#666; margin-top:5px;">Available Balance: <span
                                    id="avail-bal">0.00</span></div>
                        </div>

                        <div class="form-row" id="beneficiary-row">
                            <label class="form-label">Select Beneficiary / Account Number</label>
                            <div style="position:relative;">
                                <input type="text" id="to-account" class="form-control"
                                    placeholder="Enter Account Number" onblur="verifyAccount()" autocomplete="off">
                                <span id="verified-name" class="verified-badge"><i class="fa-solid fa-check-circle"></i>
                                    Name: <span></span></span>
                            </div>
                        </div>

                        <div class="form-row">
                            <label class="form-label">Amount</label>
                            <div style="display:flex; align-items:center;">
                                <span
                                    style="padding:10px; background:#eee; border:1px solid #ccc; border-right:none;">₹</span>
                                <input type="number" id="amount" class="form-control" placeholder="Amount"
                                    style="border-top-left-radius:0; border-bottom-left-radius:0;">
                            </div>
                        </div>

                        <div class="form-row">
                            <label class="form-label">Payment Type <i class="fa-solid fa-circle-info"
                                    style="color:#aaa;"></i></label>
                            <div class="payout-options">
                                <label class="payout-option"><input type="radio" name="payType" value="IMPS" checked>
                                    IMPS (Instant)</label>
                                <label class="payout-option"><input type="radio" name="payType" value="NEFT">
                                    NEFT</label>
                                <label class="payout-option"><input type="radio" name="payType" value="RTGS">
                                    RTGS</label>
                            </div>
                        </div>

                        <div class="form-row">
                            <label class="form-label">Date</label>
                            <input type="date" id="transfer-date" class="form-control">
                        </div>

                        <div class="form-row">
                            <label class="form-label">Note (Optional)</label>
                            <input type="text" id="note" class="form-control" placeholder="e.g. Rent, Gift">
                        </div>

                        <button type="submit" class="logout-btn"
                            style="background:#004c8f; width:100%; border-radius:5px; margin-top:10px;">Review
                            Transfer</button>

                    </form>
                </div>

                <!-- Right: History -->
                <div class="transfer-history">

                    <div class="history-card">
                        <h4>Recent Transfers <a href="#" style="font-size:12px;">View all</a></h4>
                        <ul class="history-list" id="recent-transfers">
                            <li class="history-item" style="color:#777;">Select an account to view history</li>
                        </ul>
                    </div>

                    <div class="history-card">
                        <h4>Scheduled Transfers <a href="#" style="font-size:12px;">View all</a></h4>
                        <div style="text-align:center; padding:20px; color:#777; font-size:12px;">
                            No pending transfers<br>Scheduled all are scheduled
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        if (!isLoggedIn()) window.location.href = 'index.html';

        const user = JSON.parse(localStorage.getItem('user'));
        document.getElementById('user-name').innerText = (user.fullName || user.username).toUpperCase();
        document.getElementById('transfer-date').valueAsDate = new Date();

        let myAccountsMap = {};

        // 1. Load User Accounts
        async function loadMyAccounts() {
            const response = await apiCall('/accounts/my-accounts');
            if (response.ok) {
                const accounts = await response.json();
                const select = document.getElementById('from-account');
                select.innerHTML = '';

                accounts.forEach(acc => {
                    myAccountsMap[acc.accountNumber] = acc;
                    const opt = document.createElement('option');
                    opt.value = acc.accountNumber;
                    opt.text = `${acc.accountNumber} - ₹${acc.balance.toFixed(2)}`;
                    select.appendChild(opt);
                });

                if (accounts.length > 0) {
                    updateBalance(accounts[0].accountNumber);
                    loadHistory(accounts[0].accountNumber);
                }
            }
        }

        function updateBalance(accNum) {
            if (myAccountsMap[accNum]) {
                document.getElementById('avail-bal').innerText = myAccountsMap[accNum].balance.toFixed(2);
            }
        }

        document.getElementById('from-account').addEventListener('change', (e) => {
            updateBalance(e.target.value);
            loadHistory(e.target.value); // Fetch history when account changes
        });

        // 2. Account Name Fetch Logic
        async function verifyAccount() {
            const accNum = document.getElementById('to-account').value;
            const badge = document.getElementById('verified-name');
            const nameSpan = badge.querySelector('span');

            if (accNum.length < 5) {
                badge.style.display = 'none';
                return;
            }

            // UI Alert: Checking
            showAlert('checking', 'Verifying account details...');

            try {
                const response = await apiCall(`/accounts/${accNum}`);
                if (response.ok) {
                    const acc = await response.json();
                    if (acc && acc.user) {
                        badge.style.display = 'inline-block';
                        nameSpan.innerText = acc.user.fullName || acc.user.username;
                        showAlert('info', 'Account verified! Name matched.');
                        setTimeout(() => hideAlert(), 2000);
                    }
                } else {
                    badge.style.display = 'none';
                    showAlert('danger', 'Account not found or invalid.');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // 3. Load History
        async function loadHistory(accountNumber) {
            const list = document.getElementById('recent-transfers');
            list.innerHTML = '<li class="history-item">Loading...</li>';

            const response = await apiCall(`/transactions/history/${accountNumber}`);
            if (response.ok) {
                const transactions = await response.json();
                list.innerHTML = '';

                if (transactions.length === 0) {
                    list.innerHTML = '<li class="history-item">No recent transactions</li>';
                    return;
                }

                // Show last 5
                transactions.slice(0, 5).forEach(tx => {
                    const isDebit = tx.sourceAccount && tx.sourceAccount.accountNumber === accountNumber;
                    const amountClass = isDebit ? 'text-danger' : 'text-success';
                    const icon = isDebit ? 'fa-arrow-right-from-bracket' : 'fa-arrow-right-to-bracket';
                    const sign = isDebit ? '-' : '+';

                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <div class="icon-box"><i class="fa-solid ${icon}"></i></div>
                            <div>
                                <div style="font-weight:bold;">${tx.description || 'Transfer'}</div>
                                <div style="color:#888; font-size:11px;">${new Date(tx.timestamp).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div style="font-weight:bold; color: ${isDebit ? '#dc3545' : '#28a745'}">
                            ${sign}₹${tx.amount.toFixed(2)}
                        </div>
                    `;
                    list.appendChild(li);
                });
            }
        }

        // 4. Submit Transfer
        async function submitTransfer() {
            const fromAcc = document.getElementById('from-account').value;
            const toAcc = document.getElementById('to-account').value;
            const amount = document.getElementById('amount').value;
            const note = document.getElementById('note').value;

            if (!toAcc || !amount) {
                showAlert('danger', 'Please fill in all details');
                return;
            }

            showAlert('info', 'Processing Transaction...');

            const body = {
                sourceAccountNumber: fromAcc,
                targetAccountNumber: toAcc,
                amount: amount,
                type: 'TRANSFER',
                description: note || 'Fund Transfer'
            };

            const response = await apiCall('/transactions/process', 'POST', body);
            if (response.ok) {
                showAlert('success', 'Transaction Successful! Money sent.');
                loadMyAccounts(); // Refresh balance
                loadHistory(fromAcc); // Refresh history
                document.getElementById('amount').value = '';
                document.getElementById('note').value = '';
            } else {
                const err = await response.json();
                showAlert('danger', 'Failed: ' + (err.message || 'Unknown error'));
            }
        }

        function showAlert(type, msg) {
            const el = document.getElementById('transfer-alert');
            el.className = 'alert-box'; // reset
            el.style.display = 'block';

            if (type === 'success') el.classList.add('alert-success');
            else if (type === 'danger') el.classList.add('alert-danger');
            else if (type === 'info' || type === 'checking') el.classList.add('alert-info');

            el.innerHTML = msg;
        }

        function hideAlert() {
            document.getElementById('transfer-alert').style.display = 'none';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.transfer-tab').forEach(t => t.classList.remove('active'));
            // Visual only for tab click as per quick implementation
            event.target.classList.add('active');

            // Logic to clear field or prepare internal transfer could go here
            // For now focused on "To Another SMART BANK User"
        }

        loadMyAccounts();

    </script>
</body>

</html>